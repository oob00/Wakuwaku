<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat Room</title>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
<div id="chatRoom">
    <div id="messageArea">
        <ul id="messageList">
            <!-- 메시지 목록이 동적으로 추가됩니다. -->
        </ul>
    </div>
    <input type="text" id="topic" placeholder="Type a topic..."/>
    <button id="chatroomBtn" type="button">Enter</button>
    <input type="text" id="message" placeholder="Type a message..."/>
    <button id="messageBtn" type="button">Send</button>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    $(function () {
        var socket = new SockJS('http://localhost:8080/chat'); // 서버의 WebSocket 연결 주소
        var stompClient = Stomp.over(socket);
        var currentSubscription = null; // 현재 구독을 저장할 변수

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
        });

        $('#chatroomBtn').on("click", function (event) {
            var topic = $('#topic').val();

            // 기존 구독 해제
            if (currentSubscription != null) {
                currentSubscription.unsubscribe();
                console.log('Unsubscribed from current topic');
            }

            // 서버로부터 메시지 수신을 위한 구독 설정
            currentSubscription = stompClient.subscribe('/topic/'+topic, function (message) {
                showMessage(JSON.parse(message.body).content);
            });

            showMessage(topic+" 채팅방에 접속하였습니다.");
        });

        $('#messageBtn').on("click", function (event) {
            event.preventDefault();
            var messageContent = $('#message').val();
            var topic = $('#topic').val();
            if (messageContent && stompClient) {
                var chatMessage = {
                    id: topic,
                    content: messageContent,
                };
                stompClient.send("/pub/message", {}, JSON.stringify(chatMessage));
                $('#message').val('');
            }
        });
    });

    function showMessage(message) {
        $('#messageList').append('<li>' + message + '</li>');
    }
    /*]]>*/
</script>
</body>
</html>
